import React, { useState, useEffect } from 'react';
import Swal from 'sweetalert2';

const Health = () => {
    const [isAiPage, setIsAiPage] = useState(false);
    const [aiResponse, setAiResponse] = useState('');
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [userInput, setUserInput] = useState('');

    const emotionsData = [
        { title: "ุงููุฏ ูุงูุงุชุตุงู ุงูุนุงุทูู", icon: "fa-heart", items: ["ูุบุฉ ุงูุญูุงุฑ ๐ฃ๏ธ", "ุชุจุงุฏู ุงููุธุฑุงุช ๐", "ูููุงุช ุงูุชูุฏูุฑ ๐", "ุงููุฏุงูุง ุงูุฑูุฒูุฉ ๐", "ุงูุฏุนู ููุช ุงูุฃุฒูุงุช ๐ค", "ุงูุถุญู ุงููุดุชุฑู ๐", "ูุถุงุก ููุช ุฎุงุต โ", "ุงูููุณ ุงูุนููู ๐ค", "ุงูุดุนูุฑ ุจุงูุฃูุงู ๐ก๏ธ", "ุงูุชุณุงูุญ ูุงูุตูุญ ๐ณ๏ธ", "ุงูุงุนุชุฐุงุฑ ุงูุตุงุฏู ๐", "ุงูุชุฎุทูุท ูููุณุชูุจู ๐", "ุงูุงูุชูุงู ุจุงูุชูุงุตูู โจ", "ุงูุงุญุชูุงุก ุงูููุณู ๐ซ", "ุงูุซูุฉ ุงููุชุจุงุฏูุฉ ๐"] },
        { title: "ูุบุฉ ุงูุฌุณุฏ ูุงูุชูููุฏ", icon: "fa-spa", items: ["ุงููุจูุงุช ุงูุนูููุฉ ๐", "ุงูุฃุญุถุงู ุงูุฏุงูุฆุฉ ๐ซ", "ุงูููุงุทูุฉ ุงูุฑูููุฉ ๐ธ", "ูุบุฉ ุงูุนููู โจ", "ุงููููุงุช ุงูููุณูุฉ ๐", "ุงูุชุฏููู ุงูุงุณุชุฑุฎุงุฆู ๐โโ๏ธ", "ุงููุธุงูุฉ ุงูุดุฎุตูุฉ ๐งผ", "ุงูุชุฃูู ุงูุฌุฐุงุจ ๐", "ุงูุนุทูุฑ ุงููุซูุฑุฉ ๐ฏ๏ธ", "ุงูุชูุงุนู ุจุงูููุณ ๐ค", "ุงูุงุจุชุณุงูุฉ ุงูุญุงููุฉ ๐", "ุชููุฆุฉ ุงูุฌู ุงูุนุงู ๐ฏ๏ธ", "ุงููุฏุงุนุจุฉ ุงูุนูููุฉ ๐", "ุงูุชูุงุตู ุงูุฑูุญู ๐งโโ๏ธ", "ุงูุฅุนุฌุงุจ ุงููุชุจุงุฏู ๐"] },
        { title: "ุงูุตุญุฉ ูุงูุชุจุงุฏู ุงูุฌูุณู", icon: "fa-fire", items: ["ุงูุชูุงูู ูู ุงูุฑุบุจุฉ ๐ก๏ธ", "ุงููุจุงุฏุฑุฉ ุงููุดุชุฑูุฉ โก", "ุงุณุชูุดุงู ููุงุทู ุงูุฅุซุงุฑุฉ ๐", "ุงูุชูุงุนู ุฃุซูุงุก ุงูููุงุก ๐ฅ", "ุงูุชุนุจูุฑ ุนู ุงูุงุญุชูุงุฌุงุช ๐ฌ", "ุงูุฅุดุจุงุน ุงููุชุจุงุฏู โ", "ุทูู ูุฏุฉ ุงูููุงุก โณ", "ุงูุชูุงุบู ุงูุฌุณุฏู ๐ถ", "ุงูุฑุงุญุฉ ุงูููุณูุฉ ๐งโโ๏ธ", "ุชุบููุฑ ุงูุฑูุชูู ๐", "ุงูุงูุณุฌุงู ุงูุนุถูู ๐งฌ", "ูุณุฑ ุงูุญูุงุฌุฒ ๐", "ุงูุฅุซุงุฑุฉ ุงูุจุตุฑูุฉ ๐", "ุงูุงุณุชุฌุงุจุฉ ุงูุญุณูุฉ โก", "ุนูู ุงูุชุฌุฑุจุฉ โจ"] },
        { title: "ุงููุดูุฉ ููุง ุจุนุฏูุง", icon: "fa-star", items: ["ุงููุตูู ูููุดูุฉ ๐", "ุงูุชุฒุงูู ุงูุนุงุทูู ๐", "ุงูุญุถู ุงูุนููู ุจุนุฏูุง ๐ซ", "ูููุงุช ุงูุญุจ ๐ฃ๏ธ", "ุงูุจูุงุก ูุนุงู ููุชุฑุฉ ๐งโโ๏ธ", "ูุดุงุนุฑ ุงูุฑุถุง โจ", "ุงูุนูุงูุฉ ุจุงูุทุฑู ุงูุขุฎุฑ ๐ฉน", "ุงููุฏูุก ูุงูุณูููุฉ ๐๏ธ", "ุงูุชุฃูู ุงููุดุชุฑู ๐งโโ๏ธ", "ุชุฌุฏูุฏ ุงูููุฏุฉ โค๏ธ", "ุงูุงูุชูุงู ูููุงุก ๐", "ุงูุงุณุชุฑุฎุงุก ุงูุชุงู ๐ค", "ุงูุญุฏูุซ ุงูุญููู ๐ฌ", "ุงูุชุฑุงุจุท ุงูุฑูุญู ๐", "ุงุจุชุณุงูุฉ ุงููุฏุงุน ๐"] },
        { title: "ุฃููุงุน ุงูุงุณุชูุชุงุน ูุงูุงุจุชูุงุฑ", icon: "fa-palette", items: ["ุชุบููุฑ ุงูุฃูุงูู ๐ก", "ุฃูุถุงุน ุฌุฏูุฏุฉ ูุจุงุญุฉ ๐", "ูุณุฑ ุงูุฑูุชูู ุงููุนุชุงุฏ ๐จ", "ุงูุฑูุงุฆุญ ุงููุงุฏุฆุฉ ๐ฏ๏ธ", "ุงูุชูุงุนู ุงูุณูุนู ๐", "ุงูููุงุฌุขุช ุงูุญููููุฉ ๐", "ุงูุฅุถุงุกุฉ ุงูุฎุงูุชุฉ ๐ก", "ุงูุฒู ุงูุชููุฑู ๐ญ", "ุงูุฃูุนุงุจ ุงูุฒูุฌูุฉ ๐ฒ", "ุงูุงุจุชูุงุฑ ูู ุงููุฏุงุนุจุฉ โจ", "ุงูุฎูุงู ุงููุดุชุฑู ๐ญ", "ุงูุชูุงุนู ุงููุฑุญ ๐", "ุงูุฌุฑุฃุฉ ุงููุญุจุจุฉ ๐ฅ", "ุชุบููุฑ ุงูุชูููุช โฐ", "ุงูุงุณุชูุชุงุน ุจุงูุชููุน ๐"] },
        { title: "ุงููุญุงุฐูุฑ ูุงูุถูุงุจุท", icon: "fa-shield-alt", items: ["ุชุฌูุจ ููุช ุงูุญูุถ ๐ซ", "ุชุฌูุจ ุงูุฅุชูุงู ูู ุงูุฏุจุฑ ๐", "ุงุญุชุฑุงู ุงูุฎุตูุตูุฉ ๐ค", "ุนุฏู ุฅูุดุงุก ุงูุฃุณุฑุงุฑ ๐", "ุชุฌูุจ ุงูุฅูุฑุงู โ", "ุงูุงูุชุฒุงู ุจุงูุณุชุฑ ๐งบ", "ูุฑุงุนุงุฉ ุงูุชุนุจ ๐", "ุงูุขุฏุงุจ ุงูุดุฑุนูุฉ ๐", "ุทูุงุฑุฉ ุงูููุงู ๐งผ", "ุบุถ ุงูุจุตุฑ ุนู ุงููุญุฑูุงุช ๐๏ธ", "ุงูุงุญุชุดุงู ุงููุทููุจ ๐", "ุงุญุชุฑุงู ุงูุฑุบุจุงุช ๐ค", "ุชุฌูุจ ุงูุนูู โ", "ุงูุญูุงุก ุงููุญููุฏ ๐", "ุงูุตุฏู ูู ุงููุดุงุนุฑ โ"] },
        { title: "ุงูุตุญุฉ ุงููุณููููุฌูุฉ", icon: "fa-dna", items: ["ุงููุฏุฑุฉ ุงูุจุฏููุฉ ๐ช", "ุนุฏู ูุฌูุฏ ุขูุงู ๐", "ุชูุงุฒู ุงููุฑูููุงุช ๐งฌ", "ููุงุฑุณุฉ ุงูุฑูุงุถุฉ ๐๏ธโโ๏ธ", "ุงูุชุบุฐูุฉ ุงูุฏุงุนูุฉ ๐ฅ", "ุฌูุฏุฉ ุงูููู ๐ด", "ุงููุดุงุท ุงูุนุงู โก", "ุงูุตุญุฉ ุงูุฅูุฌุงุจูุฉ ๐ถ", "ุงููุฒู ุงููุซุงูู โ๏ธ", "ุงููุญูุตุงุช ุงูุฏูุฑูุฉ ๐ฉบ", "ุงูุฑุงุญุฉ ุงูุฌุณุฏูุฉ ๐งโโ๏ธ", "ุชุฌูุจ ุงูุชุฏุฎูู ๐ญ", "ุดุฑุจ ุงููุงุก ๐ง", "ุงููุฑููุฉ ุงูุฌุณุฏูุฉ ๐งโโ๏ธ", "ููุฉ ุงูุฃุนุตุงุจ ๐ง"] },
        { title: "ุงูุนูุงุฆู ูุงููุดููุงุช", icon: "fa-exclamation-triangle", items: ["ุงูุถุบูุท ุงูููุณูุฉ ๐ช๏ธ", "ุงูุดุบุงู ุจุงู ุจุงูุฃุจูุงุก ๐ง", "ุงูุชุนุจ ูุงูุฌูุฏ ๐", "ุงูููู ุงูุฒูุฌู ๐ค", "ุงุถุทุฑุงุจ ุตูุฑุฉ ุงูุฌุณุฏ ๐ช", "ูุดููุงุช ุงูุนูู ๐ผ", "ุงูุฎูุงูุงุช ุงูุฌุงูุจูุฉ ๐ฃ๏ธ", "ููุต ุงูุซูุงูุฉ ๐", "ุงูุฎุฌู ุงูุฒุงุฆุฏ ๐", "ุถุนู ุงูุชูุงุตู ๐ต", "ุงูุจุฑูุฏ ุงูุนุงุทูู ๐ง", "ุณุฑุนุฉ ุงููุฐู/ุงููุตูู โณ", "ุงูุชุดุชุช ุงูุฐููู ๐ญ", "ุงูุชุฏุฎูุงุช ุงูุฎุงุฑุฌูุฉ ๐ช", "ุงูุฃุฒูุงุช ุงููุงููุฉ ๐ธ"] },
        { title: "ุงูุซูุงูุฉ ูุงููุนู", icon: "fa-brain", items: ["ุณูููููุฌูุฉ ุงูุฑุฌู ๐ง", "ุณูููููุฌูุฉ ุงููุฑุฃุฉ ๐ธ", "ูุชุจ ุงูุชูููุฉ ุงูุฒูุฌูุฉ ๐", "ููุงุท ุงููุชุนุฉ ๐ฏ", "ุงูุฐูุงุก ุงูุนุงุทูู ๐ก", "ูู ุงูุงุญุชูุงุก ๐ซ", "ูุบุงุช ุงูุญุจ ุงูุฎูุณ โค๏ธ", "ุฅุฏุงุฑุฉ ุงูุฎูุงู โ๏ธ", "ุชุทููุฑ ุงูุฐุงุช ๐", "ููู ุงูุงุญุชูุงุฌุงุช ๐ฌ", "ุงููุนู ุงูุตุญู ๐ฉบ", "ุซูุงูุฉ ุงูุญูุงุฑ ๐ฃ๏ธ", "ุชูุฏูุฑ ุงููุฑูู ๐ฅ", "ุงูุชุนูู ุงููุณุชูุฑ ๐", "ุงููุถุฌ ุงูููุณู ๐งโโ๏ธ"] },
        { title: "ุงูุงุทูุฆูุงู ุงูุฑูุญู", icon: "fa-pray", items: ["ุงูุฏุนุงุก ูุจู ุงูุนูุงูุฉ ๐คฒ", "ุงูุบุณู ุงููุดุชุฑู ๐ฟ", "ุดูุฑ ุงููู ุนูู ุงูุณูู ๐", "ููุฉ ุงูุฅุนูุงู ๐", "ุฐูุฑ ุงููู ุงูุฏุงุฆู ๐ฟ", "ุงูุจุฑูุฉ ูู ุงูููุงุก โจ", "ุงุณุชุญุถุงุฑ ุงูุฃุฌุฑ ๐", "ุทูุงุฑุฉ ุงูุฑูุญ ๐ค", "ุงูุชููู ุนูู ุงููู ๐น", "ุตูุงุจุฉ ุงูุฑุงุจุทุฉ ๐", "ุงูููุฏุฉ ูุงูุฑุญูุฉ ๐๏ธ", "ุงูุฅุญุณุงู ูู ุงูุนุดุฑุฉ โจ", "ุงูุงุญุชุณุงุจ ุนูุฏ ุงููู ๐", "ุงูุฑุถุง ุงูููุจู ๐", "ุงูุณูููุฉ ุงูููุฒููุฉ ๐ก"] }
    ];

    const saveAndAnalyze = async (cat, val) => {
        Swal.close();
        setIsAiPage(true);
        setIsAnalyzing(true);
        setAiResponse('');

        try {
            await fetch('/api/save-health', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: 1, category: cat, value: 1, note: val })
            });

            const res = await fetch('/api/raqqa-ai', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: `ุฃูุชู ุฑูุฉุ ุงููุณุชุดุงุฑุฉ ุงูููุณูุฉ ูุงูุฒูุฌูุฉ. ุงููุณุชุฎุฏูุฉ ุฃุฏุฎูุช ุงูุจูุงูุงุช ุงูุชุงููุฉ: (ุงููุงุฆูุฉ: ${cat}ุ ุงููุฏุฎู: ${val}). ูููู ุจุชุญููู ุญุงูุชูุง ุงูููุณูุฉ ูุงูุนูุงูุฉ ุจูุงุกู ุนูู ูุฐุง ุงููุฏุฎู. ูุฏูู ุฑุฏุงู ููุณุนุงู ูุชุถูู: ุชุญููู ููุงุท ุงูููุฉุ ุงููุฌูุงุช ุงููุญุชููุฉุ ุชูุตูุงุช ุนูููุฉ ุฐููุฉุ ููุตูุญุฉ ุฅููุงููุฉ ุจุฃุณููุจ ุฏุงูุฆ.` })
            });
            const data = await res.json();
            setAiResponse(data.reply);
            
            // ุญูุธ ูุญูู ููุณุฌู
            const history = JSON.parse(localStorage.getItem('psy_history') || '[]');
            history.push({ t: new Date().toLocaleString('ar-EG'), q: val, r: data.reply });
            localStorage.setItem('psy_history', JSON.stringify(history));

        } catch (e) {
            setAiResponse(`ุชู ุญูุธ ุงูููุงุญุธุฉ (${val}). ูุงุฌูุช "ุฑูุฉ" ูุดููุฉ ูู ุงูุฑุจุท ุจุงูุฐูุงุก ุงูุตูุงุนู ุญุงููุงู.`);
        } finally {
            setIsAnalyzing(false);
        }
    };

    const openOptions = (title, items) => {
        Swal.fire({
            title: title,
            html: `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                ${items.map(i => `<button class="swal2-confirm swal2-styled" style="background:#fff9fa; color:#800020; border:1px solid #fce4ec; margin:0; font-size:12px;" onclick="window.dispatchAction('${title}', '${i}')">${i}</button>`).join('')}
            </div>`,
            showConfirmButton: false, showCloseButton: true
        });
    };

    useEffect(() => {
        window.dispatchAction = (title, item) => saveAndAnalyze(title, item);
        return () => delete window.dispatchAction;
    }, []);

    return (
        <div className="container" style={{ paddingTop: '20px' }}>
            {!isAiPage ? (
                <div className="page active">
                    <div className="ai-entry-card" onClick={() => setIsAiPage(true)} style={{background: 'linear-gradient(45deg, #800020, #b03060)', color: 'white', padding: '25px', borderRadius: '25px', textAlign: 'center', marginBottom: '25px', cursor: 'pointer'}}>
                        <i className="fas fa-magic"></i>
                        <h3>ูุญูู ุงูุนูุงูุงุช ุงูุฐูู</h3>
                        <p>ุจูุญูู ุขูู.. ุฑูุฉ ุชููุญูู ุจุตูุฑุฉ ููุณูุฉ</p>
                    </div>
                    <div className="grid-container" style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                        {emotionsData.map((cat, index) => (
                            <div key={index} className="category-card" onClick={() => openOptions(cat.title, cat.items)} style={{background: 'rgba(255,255,255,0.9)', padding: '20px', borderRadius: '20px', textAlign: 'center', border: '1px solid #eee', cursor: 'pointer'}}>
                                <i className={`fas ${cat.icon}`} style={{color: '#800020', fontSize: '24px', marginBottom: '10px', display: 'block'}}></i>
                                <span style={{fontSize: '13px', fontWeight: 'bold'}}>{cat.title}</span>
                            </div>
                        ))}
                    </div>
                </div>
            ) : (
                <div className="page active">
                    <div className="ai-interface" style={{background: 'white', padding: '20px', borderRadius: '30px', minHeight: '500px'}}>
                        <div id="ai-chat-box" style={{height: '350px', overflowY: 'auto', background: '#fafafa', borderRadius: '20px', padding: '15px', marginBottom: '15px'}}>
                            {isAnalyzing ? <div style={{textAlign:'center'}}><i className="fas fa-heartbeat fa-spin"></i> ุฑูุฉ ุชุญูู...</div> : <div>{aiResponse || "ุตูู ุดุนูุฑูู ูุฑูุฉ..."}</div>}
                        </div>
                        <textarea value={userInput} onChange={(e)=>setUserInput(e.target.value)} placeholder="ุงูุชุจู ููุง..." style={{width:'100%', height:'80px', borderRadius:'15px', padding:'10px'}}></textarea>
                        <button onClick={()=>saveAndAnalyze('ุงุณุชุดุงุฑุฉ ุฎุงุตุฉ', userInput)} style={{width:'100%', padding:'15px', background:'#800020', color:'white', borderRadius:'20px', border:'none', marginTop:'10px'}}>ุชุญููู ุงูุฐูุงุก ุงูุตูุงุนู โจ</button>
                        <button onClick={()=>setIsAiPage(false)} style={{width:'100%', marginTop:'10px', background:'none', border:'none', color:'#999'}}>ุงูุนูุฏุฉ ููููุงุฆู</button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default Health;
