<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منتدى الأرجوحة | رقة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --p1: #ff85c0; --p2: #eb2f96; --purp: #8e44ad; 
            --bg: #fdf6f9; --glass: rgba(255, 255, 255, 0.9);
        }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #444; }

        /* Header & Horizontal Scroll Nav */
        header { background: white; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .scroll-nav { display: flex; overflow-x: auto; white-space: nowrap; padding: 0 15px; gap: 15px; scrollbar-width: none; }
        .scroll-nav::-webkit-scrollbar { display: none; }
        .nav-item { display: inline-flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.3s; }
        .nav-item i { width: 45px; height: 45px; background: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--purp); font-size: 20px; border: 1px solid #eee; }
        .nav-item span { font-size: 12px; font-weight: bold; color: #666; }
        .nav-item:active { transform: scale(0.9); }

        /* AI Floating Button */
        .ai-float { position: fixed; bottom: 100px; left: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--p2), var(--purp)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 999; cursor: pointer; }

        /* Post Box */
        .post-box { background: white; margin: 15px; padding: 15px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .post-input { width: 100%; border: none; outline: none; font-family: 'Tajawal'; font-size: 15px; resize: none; min-height: 60px; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f5f5f5; }
        .file-label { color: var(--p2); cursor: pointer; font-size: 20px; }
        .btn-post { background: var(--p2); color: white; border: none; padding: 8px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* Feed */
        .feed-container { padding: 0 15px; }
        .post-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-avatar { width: 40px; height: 40px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #999; }
        .post-meta { font-size: 13px; font-weight: bold; color: #333; }
        .post-content { font-size: 14px; line-height: 1.6; color: #555; margin-bottom: 10px; }
        .post-media { width: 100%; border-radius: 15px; margin-top: 10px; }

        /* Chat UI */
        #chat-overlay { display: none; position: fixed; inset: 0; background: white; z-index: 2000; flex-direction: column; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #fdfbfd; }
        .msg { padding: 12px 16px; border-radius: 20px; max-width: 80%; font-size: 14px; }
        .msg-user { align-self: flex-start; background: #f0f0f0; }
        .msg-ai { align-self: flex-end; background: var(--p2); color: white; }
    </style>
</head>
<body>

<header>
    <div class="scroll-nav">
        <div class="nav-item" onclick="openSection('Emerald%20Kitchen')"><i class="fas fa-utensils"></i><span>مطبخ الزمرد</span></div>
        <div class="nav-item" onclick="openSection('Icon%20Closet')"><i class="fas fa-tshirt"></i><span>خزانة أيقونة</span></div>
        <div class="nav-item" onclick="openSection('Expression%20Harbor')"><i class="fas fa-anchor"></i><span>مرفأ البوح</span></div>
        <div class="nav-item" onclick="openSection('Academy')"><i class="fas fa-graduation-cap"></i><span>أكاديمية رقة</span></div>
        <div class="nav-item" onclick="openSection('Seed%20of%20Hope')"><i class="fas fa-baby"></i><span>بذرة الأمل</span></div>
        <div class="nav-item" onclick="openSection('Shopping%20Compass')"><i class="fas fa-shopping-bag"></i><span>بوصلة التسوق</span></div>
        <div class="nav-item" onclick="openSection('Swing%20Bazaar')"><i class="fas fa-store"></i><span>سوق الأرجوحة</span></div>
        <div class="nav-item" onclick="openSection('Wellness%20Haven')"><i class="fas fa-leaf"></i><span>ملاذ العافية</span></div>
        <div class="nav-item" onclick="openSection('Challenges')"><i class="fas fa-trophy"></i><span>صندوق التحدي</span></div>
    </div>
</header>

<div class="ai-float" onclick="openAIChat()"><i class="fas fa-robot"></i></div>

<div class="post-box">
    <textarea id="postContent" class="post-input" placeholder="ماذا يدور في ذهنك يا رقيقة؟"></textarea>
    <div class="post-actions">
        <label class="file-label" for="fileInput"><i class="fas fa-image"></i></label>
        <input type="file" id="fileInput" hidden accept="image/*">
        <button class="btn-post" onclick="handlePostSubmit()">نشر الآن</button>
    </div>
</div>

<div class="feed-container" id="postsFeed">
    <div style="text-align:center; padding:20px; color:#999;">جاري تحميل نبض المنتدى...</div>
</div>

<div id="chat-overlay">
    <div class="chat-header">
        <i class="fas fa-times" onclick="closeChat()" style="cursor:pointer;"></i>
        <span style="font-weight:bold; color:var(--p2);">رقة الذكية</span>
        <i class="fas fa-magic" style="color:var(--p2);"></i>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div style="padding:15px; display:flex; gap:10px; border-top:1px solid #eee;">
        <input type="text" id="aiInput" style="flex:1; padding:12px; border-radius:25px; border:1px solid #eee; outline:none;" placeholder="اسألي رقة أي شيء...">
        <button onclick="sendToAI()" style="background:var(--p2); color:white; border:none; padding:10px 20px; border-radius:25px;"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    const API_GET = '/api/get-posts';
    const API_SAVE = '/api/save-post';
    const API_AI = '/api/raqqa-ai';

    // 1. جلب المحتوى من نيون (Neon)
    async function loadPosts() {
        try {
            const res = await fetch(API_GET);
            const data = await res.json();
            const container = document.getElementById('postsFeed');
            container.innerHTML = '';

            data.posts.forEach(post => {
                const mediaHtml = post.media_url ? `<img src="${post.media_url}" class="post-media">` : '';
                container.innerHTML += `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-avatar"><i class="fas fa-user-soft"></i></div>
                            <div class="post-meta">مشاركة في ${post.section || 'الأرجوحة'}</div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${mediaHtml}
                    </div>
                `;
            });
        } catch (e) {
            console.error("Error fetching posts:", e);
        }
    }

    // 2. النشر والحفظ في قاعدة البيانات
    async function handlePostSubmit() {
        const content = document.getElementById('postContent').value;
        const file = document.getElementById('fileInput').files[0];

        if (!content && !file) return Swal.fire('تنبيه', 'اكتبي شيئاً أولاً يا رقيقة', 'warning');

        const formData = new FormData();
        formData.append('content', content);
        formData.append('section', 'منتدى الأرجوحة العامة');
        formData.append('type', file ? 'صورة' : 'نصي');
        if (file) formData.append('file', file);

        Swal.fire({ title: 'جاري النشر...', didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(API_SAVE, { method: 'POST', body: formData });
            if (res.ok) {
                document.getElementById('postContent').value = '';
                document.getElementById('fileInput').value = '';
                Swal.fire('تم النشر', 'مشاركتكِ تزين المنتدى الآن', 'success');
                loadPosts();
            }
        } catch (e) {
            Swal.fire('خطأ', 'تعذر النشر حالياً', 'error');
        }
    }

    // 3. الذكاء الاصطناعي (رقة)
    async function sendToAI() {
        const input = document.getElementById('aiInput');
        const text = input.value;
        if (!text) return;

        const container = document.getElementById('chat-messages');
        container.innerHTML += `<div class="msg msg-user">${text}</div>`;
        input.value = '';

        try {
            const res = await fetch(API_AI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: text })
            });
            const data = await res.json();
            container.innerHTML += `<div class="msg msg-ai">${data.reply}</div>`;
        } catch (e) {
            container.innerHTML += `<div class="msg msg-ai">عذراً رفيقتي، أنا مشغولة قليلاً الآن.</div>`;
        }
        container.scrollTop = container.scrollHeight;
    }

    // 4. وظائف التنقل والفتح
    function openSection(name) {
        const baseUrl = "https://raqqa-v6cd-7xk6c09lb-raqqs-projects.vercel.app/swing.html";
        window.location.href = `${baseUrl}?section=${name}`;
    }

    function openAIChat() { document.getElementById('chat-overlay').style.display = 'flex'; }
    function closeChat() { document.getElementById('chat-overlay').style.display = 'none'; }

    window.onload = loadPosts;
</script>

</body>
</html>
