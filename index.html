<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رقة - مستشارتكِ الذكية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --pink: #ff85a2; --soft-bg: #fff5f7; --text: #4a4a4a; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--soft-bg); margin: 0; padding: 0; }
        
        /* شريط التنقل العلوي */
        .top-nav { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); sticky: top; z-index: 1000; }
        
        /* شاشة الشات */
        #chat-window { height: 300px; overflow-y: auto; padding: 20px; background: white; margin: 10px; border-radius: 15px; border: 1px solid #fce4ec; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .user-msg { background: var(--pink); color: white; align-self: flex-start; margin-right: auto; }
        .raqqa-msg { background: #f0f0f0; color: var(--text); }

        /* الأقسام الخمسة */
        .categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; padding: 15px; }
        .cat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid #eee; }
        .cat-card:hover { transform: translateY(-5px); border-color: var(--pink); }

        /* عرض المحتوى والمكتبة */
        #content-viewer { display: none; background: white; padding: 20px; margin: 10px; border-radius: 15px; position: relative; }
        .hamssa-box { border-right: 4px solid var(--pink); padding: 10px; background: #fff9fa; margin: 15px 0; font-style: italic; }
        
        /* أزرار التفاعل */
        .actions { display: flex; gap: 15px; padding: 10px 0; border-top: 1px solid #eee; margin-top: 15px; }
        .action-btn { cursor: pointer; color: #666; transition: 0.2s; }
        .action-btn:hover { color: var(--pink); }

        /* الـ 11 متابعة صحية */
        .health-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .health-item { background: #fff; padding: 10px; border-radius: 10px; text-align: center; font-size: 0.8rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* مدخلات الشات */
        .chat-input-area { display: flex; padding: 10px; background: white; sticky: bottom; }
        #chat-input { flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 20px; outline: none; }
        .send-btn { background: var(--pink); color: white; border: none; padding: 10px 20px; border-radius: 20px; margin-right: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="top-nav">
    <strong>رقة ✨</strong>
    <a href="https://facebook.com/yourpage" target="_blank"><i class="fab fa-facebook" style="color: #1877f2; font-size: 24px;"></i></a>
</div>

<div id="chat-window">
    <div class="msg raqqa-msg">أهلاً بكِ يا رقيقة في مساحتكِ الخاصة.. كيف يمكنني مساندتكِ اليوم؟</div>
</div>
<div class="chat-input-area">
    <input type="text" id="chat-input" placeholder="اكتبي سؤالكِ هنا...">
    <button class="send-btn" onclick="sendMessage()">إرسال</button>
</div>

<div class="categories">
    <div class="cat-card" onclick="fetchNeonContent('feelings')"><i class="fas fa-heart"></i><br>المشاعر</div>
    <div class="cat-card" onclick="fetchNeonContent('society')"><i class="fas fa-users"></i><br>المجتمع</div>
    <div class="cat-card" onclick="fetchNeonContent('health')"><i class="fas fa-heartbeat"></i><br>الصحة</div>
    <div class="cat-card" onclick="fetchNeonContent('fiqh')"><i class="fas fa-book-open"></i><br>الفقه</div>
    <div class="cat-card" onclick="fetchNeonContent('intimacy')"><i class="fas fa-dove"></i><br>الحميمية</div>
</div>

<div id="content-viewer">
    <button onclick="this.parentElement.style.display='none'" style="float:left; border:none; background:none;">✖</button>
    <h3 id="view-title">عنوان القسم</h3>
    <div id="view-hamssa" class="hamssa-box">الهمسة الثابتة...</div>
    <div id="view-body">جاري تحميل المحتوى من المكتبة...</div>
    
    <div class="actions">
        <span class="action-btn" onclick="likePost(this)"><i class="far fa-heart"></i> <span class="count">0</span></span>
        <span class="action-btn" onclick="showCommentBox()"><i class="far fa-comment"></i> تعليق</span>
        <span class="action-btn" onclick="shareSocial('fb')"><i class="fab fa-facebook-f"></i></span>
        <span class="action-btn" onclick="shareSocial('wa')"><i class="fab fa-whatsapp"></i></span>
    </div>
</div>

<div id="health-app-internal" style="padding: 15px;">
    <h4>متابعاتكِ الصحية اليومية</h4>
    <div class="health-grid" id="healthGrid">
        </div>
</div>

<script>
// 1. نظام الـ 11 متابعة بذكاء (تفاصيل دقيقة لكل ما تحتاجه المرأة)
const healthTools = [
    { id: 'period', name: 'الحيض', icon: 'fa-droplet', desc: 'تتبع اللون، غزارة التدفق، التقلصات، والتحكم في المزاج.' },
    { id: 'preg', name: 'الحمل', icon: 'fa-baby', desc: 'حساب الركلات، مراقبة الغثيان، وتطور حجم الجنين أسبوعياً.' },
    { id: 'nurse', name: 'الرضاعة', icon: 'fa-vial', desc: 'توقيت الرضعة (يمين/يسار)، لون الإخراج، وكمية شرب الماء للأم.' },
    { id: 'mom', name: 'الأمومة', icon: 'fa-child', desc: 'متابعة نوبات الغضب، تطور الكلام، ومواعيد التطعيمات.' },
    { id: 'food', name: 'تغذية', icon: 'fa-apple-alt', desc: 'معدل حرق السعرات، الفيتامينات اليومية، وساعات الصيام المتقطع.' },
    { id: 'doc', name: 'طبيب', icon: 'fa-user-md', desc: 'أرشيف التحاليل، مواعيد السونار، وأسئلة تودين طرحها على طبيبك.' },
    { id: 'sport', name: 'رياضة', icon: 'fa-running', desc: 'تمارين كيجل، المشي المنزلي، واليوجا الصباحية.' },
    { id: 'weight', name: 'ميزان', icon: 'fa-weight', desc: 'قياسات الخصر، الورك، وتغير الوزن خلال الشهر.' },
    { id: 'beauty', name: 'عناية', icon: 'fa-magic', desc: 'روتين البشرة الليلي، تتبع تساقط الشعر، وقوة الأظافر.' },
    { id: 'sleep', name: 'نوم', icon: 'fa-moon', desc: 'ساعات النوم العميق، جودة الأحلام، وعدد مرات الاستيقاظ ليلاً.' },
    { id: 'water', name: 'ماء', icon: 'fa-tint', desc: 'تنبيه ذكي كل ساعتين للحفاظ على نضارة بشرتك.' }
];

function initHealthGrid() {
    const grid = document.getElementById('healthGrid');
    grid.innerHTML = healthTools.map(t => `
        <div class="health-item" onclick="openHealthTool('${t.id}', '${t.name}', '${t.desc}')">
            <i class="fas ${t.icon}" style="color:var(--pink)"></i><br>${t.name}
        </div>
    `).join('');
}

function openHealthTool(id, name, desc) {
    alert(`تطبيق ${name} الداخلي:\n${desc}\n(يتم الحفظ في قاعدة بيانات نيون...)`);
}

// 2. دالة الشات الذكي (المرتبطة بالـ API)
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const window = document.getElementById('chat-window');
    const message = input.value.trim();
    if (!message) return;

    appendMessage('user', message);
    input.value = '';

    try {
        const response = await fetch('/api/raqqa-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: message })
        });

        if (response.status === 404) throw new Error("404");

        const data = await response.json();
        appendMessage('raqqa', data.reply);
    } catch (error) {
        appendMessage('raqqa', "عذراً يا رقيقة، واجهت مشكلة في الاتصال بالخادم.");
    }
}

function appendMessage(sender, text) {
    const chatWindow = document.getElementById('chat-window');
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${sender === 'user' ? 'user-msg' : 'raqqa-msg'}`;
    msgDiv.innerText = text;
    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// 3. جلب المحتوى من Neon (ترتيب الأقسام والمعرفات)
async function fetchNeonContent(category) {
    const viewer = document.getElementById('content-viewer');
    viewer.style.display = 'block';
    document.getElementById('view-title').innerText = `قسم ${category}`;
    
    // محاكاة استدعاء Neon DB
    try {
        const res = await fetch(`/api/get-posts?cat=${category}`);
        const data = await res.json();
        document.getElementById('view-body').innerHTML = data.content || "لا يوجد منشورات في هذه المكتبة بعد.";
    } catch {
        document.getElementById('view-body').innerText = "حدث خطأ أثناء جلب محتوى المكتبة.";
    }
}

// 4. أزرار التفاعل (إعجاب، مشاركة)
function likePost(el) {
    const icon = el.querySelector('i');
    const count = el.querySelector('.count');
    icon.classList.toggle('fas');
    icon.classList.toggle('far');
    icon.style.color = icon.classList.contains('fas') ? 'red' : '#666';
    count.innerText = parseInt(count.innerText) + (icon.classList.contains('fas') ? 1 : -1);
}

function shareSocial(platform) {
    const url = window.location.href;
    const text = "تابعي رقة - رفيقتكِ الذكية";
    if(platform === 'fb') window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`);
    if(platform === 'wa') window.open(`https://api.whatsapp.com/send?text=${text} ${url}`);
}

window.onload = initHealthGrid;
</script>

</body>
    </html>
