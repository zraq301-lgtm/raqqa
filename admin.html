<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø±Ù‚Ø© - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script type="module">
        import { upload } from 'https://esm.run/@vercel/blob/client';
        window.blobUpload = upload;
    </script>

    <style>
        :root { --primary: #e91e63; --secondary: #673ab7; --bg: #fdf6f8; --dark: #333; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); padding: 15px; direction: rtl; }
        .admin-container { max-width: 650px; margin: 0 auto; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 25px; font-weight: 700; }
        .card { background: #fff; border: 1px solid #f1f1f1; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        label { display: block; margin: 12px 0 5px; font-weight: bold; color: var(--dark); }
        input, textarea, select { width: 100%; padding: 12px; border: 1.5px solid #eee; border-radius: 12px; margin-bottom: 10px; font-family: 'Tajawal'; box-sizing: border-box; outline: none; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { padding: 14px; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; color: white; width: 100%; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-upload { background: var(--primary); }
        .btn-ai { background: var(--secondary); }
        .btn-clear { background: #f1f1f1; color: #666; width: 35%; }
        .btn-delete { background: var(--dark); }
        #progress-container { display: none; margin: 15px 0; background: #eee; border-radius: 10px; overflow: hidden; height: 12px; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); transition: 0.3s; }
        #preview { margin: 15px 0; border-radius: 15px; text-align: center; background: #fafafa; border: 2px dashed #eee; min-height: 50px; overflow: hidden; }
        #preview img, #preview video { max-width: 100%; border-radius: 12px; max-height: 250px; }
        .loading-spinner { display: none; text-align: center; color: var(--secondary); margin: 10px 0; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1><i class="fas fa-gem"></i> Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ØªÙˆÙ‰ Ø±Ù‚Ø©</h1>

    <div class="card">
        <h3><i class="fas fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ</h3>
        <textarea id="ai-prompt" rows="2" placeholder="Ø§ÙƒØªØ¨ÙŠ ÙÙƒØ±Ø© Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨ØµÙŠØ§ØºØªÙ‡Ø§..."></textarea>
        <div class="btn-group">
            <button class="btn btn-ai" onclick="generateAIContent()">
                <i class="fas fa-sparkles"></i> ØªÙˆÙ„ÙŠØ¯ Ù†Øµ
            </button>
            <button class="btn btn-clear" onclick="document.getElementById('main-content').value = ''">
                <i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø©
            </button>
        </div>
        <div id="ai-loading" class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Ø±Ù‚Ø© ØªÙƒØªØ¨ Ù„ÙƒÙ Ø§Ù„Ø¢Ù†...</div>
    </div>

    <div class="card">
        <h3><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
        
        <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±:</label>
        <textarea id="main-content" rows="4" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§..."></textarea>

        <label>Ø¥Ø±ÙØ§Ù‚ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØ±Ø©:</label>
        <input type="file" id="file-input" accept="video/*,image/*" onchange="handlePreview(this)">
        
        <div id="preview">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>

        <div id="progress-container">
            <div id="progress-bar"></div>
            <p id="progress-text" style="text-align: center; font-size: 11px; margin-top: 5px; color: var(--primary);">0%</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>Ø§Ù„Ù‚Ø³Ù…:</label>
                <select id="section-select">
                    <option value="bouh-display-1">ğŸŒ¸ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± ÙˆØ§Ù„Ø¨ÙˆØ­</option>
                    <option value="bouh-display-2">ğŸ•¯ï¸ Ø§Ù„Ø­Ù…ÙŠÙ…ÙŠØ©</option>
                    <option value="bouh-display-3">ğŸ©º Ø§Ù„ØµØ­Ø©</option>
                    <option value="bouh-display-4">ğŸ¡ Ø£Ø±Ø¬ÙˆØ­Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±</option>
                    <option value="bouh-display-5">ğŸ“œ Ø§Ù„ÙÙ‚Ù‡</option>
                </select>
            </div>
            <div>
                <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù:</label>
                <select id="type-select">
                    <option value="Ù†ØµÙŠ">Ù†Øµ ÙÙ‚Ø·</option>
                    <option value="ØµÙˆØ±Ø©">ØµÙˆØ±Ø©</option>
                    <option value="ÙÙŠØ¯ÙŠÙˆ">ÙÙŠØ¯ÙŠÙˆ</option>
                </select>
            </div>
        </div>

        <button class="btn btn-upload" onclick="startPublish()" style="margin-top: 20px;">
            <i class="fas fa-cloud-upload-alt"></i> Ù†Ø´Ø± Ø§Ù„Ø¢Ù† ÙÙŠ Ù†ÙŠÙˆÙ†
        </button>
    </div>

    <div class="card">
        <h3><i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ù…Ù†Ø´ÙˆØ±</h3>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ± (ID):</label>
        <input type="number" id="delete-id" placeholder="Ø£Ø¯Ø®Ù„ÙŠ ID Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù„Ù„Ø­Ø°Ù">
        <button class="btn btn-delete" onclick="deletePost()">
            <i class="fas fa-trash"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
        </button>
    </div>
</div>

<script>
    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±
    function handlePreview(input) {
        const preview = document.getElementById('preview');
        const typeSelect = document.getElementById('type-select');
        preview.innerHTML = '';
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            if (file.type.startsWith('video')) {
                preview.innerHTML = `<video src="${url}" controls></video>`;
                typeSelect.value = 'ÙÙŠØ¯ÙŠÙˆ';
            } else {
                preview.innerHTML = `<img src="${url}">`;
                typeSelect.value = 'ØµÙˆØ±Ø©';
            }
        }
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø·ÙˆØ± (Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø± Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Vercel Blob)
    async function startPublish() {
        const fileInput = document.getElementById('file-input');
        const content = document.getElementById('main-content').value;
        const section = document.getElementById('section-select').value;
        const type = document.getElementById('type-select').value;
        const file = fileInput.files[0];

        if (!content && !file) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù', 'warning');

        try {
            let mediaUrl = null;
            if (file) {
                // ØªÙØ¹ÙŠÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                document.getElementById('progress-container').style.display = 'block';
                const pBar = document.getElementById('progress-bar');
                const pText = document.getElementById('progress-text');

                // Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: Ù‡Ø°Ø§ Ù…Ø§ ÙŠØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ ØµÙˆØ±ØªÙƒ
                const blob = await window.blobUpload(file.name, file, {
                    access: 'public',
                    handleUploadUrl: '/api/upload-token', // ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…Ø¬Ù„Ø¯ api
                    onUploadProgress: (p) => {
                        pBar.style.width = p.percentage + '%';
                        pText.innerText = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·... ${p.percentage}%`;
                    }
                });
                mediaUrl = blob.url;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù†ÙŠÙˆÙ† (Neon DB)
            const res = await fetch('/api/save-post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, section, type, media_url: mediaUrl })
            });

            if (res.ok) {
                Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error();
            }
        } catch (err) {
            Swal.fire('Ø®Ø·Ø£', 'ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Vercel Blob ÙˆÙ…Ù„Ù upload-token', 'error');
        }
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    async function generateAIContent() {
        const prompt = document.getElementById('ai-prompt').value;
        if (!prompt) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ÙŠ ÙÙƒØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'info');
        document.getElementById('ai-loading').style.display = 'block';
        try {
            const res = await fetch('/api/raqqa-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            const data = await res.json();
            document.getElementById('main-content').value = data.reply;
        } catch (err) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', 'error');
        }
        document.getElementById('ai-loading').style.display = 'none';
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù
    async function deletePost() {
        const id = document.getElementById('delete-id').value;
        if (!id) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù€ ID', 'info');
        const confirm = await Swal.fire({
            title: 'Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø©ØŸ',
            text: "Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Neon DB",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙŠ'
        });
        if (confirm.isConfirmed) {
            try {
                const res = await fetch(`/api/delete-post?id=${id}`, { method: 'DELETE' });
                if (res.ok) Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                else Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©', 'error');
            } catch (err) {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
    }
</script>
</body>
    </html>
