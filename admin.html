<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم رقة - الإدارة المتطورة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-pink: #e91e63; --soft-pink: #fce4ec; --ai-purple: #673ab7; --save-cyan: #00bcd4; --delete-red: #d32f2f; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f8f9fa; padding: 20px; direction: rtl; }
        .container { max-width: 850px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h1 { color: var(--primary-pink); text-align: center; font-family: 'Tajawal'; }
        .card { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { color: white; padding: 14px 20px; border: none; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
        .btn-ai { background-color: var(--ai-purple); }
        .btn-save { background-color: var(--save-cyan); }
        .btn-delete { background-color: var(--delete-red); }
        .message { padding: 15px; border-radius: 10px; display: none; margin-top: 10px; text-align: center; }
        .success { background: #e6fffa; color: #2c7a7b; }
        .error { background: #fff5f5; color: #c53030; }
        #admin-content { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-heart"></i> لوحة تحكم رقة</h1>

    <div id="login-form">
        <input type="password" id="admin-password" placeholder="أدخلي كلمة مرور المطور">
        <button class="btn-save" onclick="checkAuth()">دخول</button>
    </div>

    <div id="admin-content">
        <div class="card">
            <h2><i class="fas fa-robot"></i> المكتبة الذكية (Mixedbread RAG)</h2>
            <textarea id="ai-prompt" rows="2" placeholder="اسألي رقة لتوليد نص من ملفاتك..."></textarea>
            <button class="btn-ai" onclick="generateAI()"><i class="fas fa-magic"></i> توليد نص ذكي</button>
        </div>

        <div class="card">
            <h2><i class="fas fa-paper-plane"></i> نشر محتوى جديد</h2>
            
            <label>النص البرمجي/المقال:</label>
            <textarea id="main-content" rows="4" placeholder="اكتبي النص هنا..."></textarea>
            
            <label>رابط الوسائط (صورة أو فيديو):</label>
            <input type="text" id="media-url" placeholder="الصقي رابط الفيديو أو الصورة هنا (أو استخدمي الرفع بالأسفل)">
            
            <input type="file" id="file-upload" accept="image/*,video/*">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>القسم:</label>
                    <select id="section-select">
                        <option value="bouh-display-1">المشاعر</option>
                        <option value="bouh-display-4">المجتمع</option>
                        <option value="bouh-display-2">الصحة</option>
                        <option value="bouh-display-3">الفقه</option>
                        <option value="bouh-display-5">الحميمية</option>
                    </select>
                </div>
                <div>
                    <label>النوع:</label>
                    <select id="type-select">
                        <option value="نصي">نصي</option>
                        <option value="صورة">صورة</option>
                        <option value="فيديو">فيديو</option>
                    </select>
                </div>
            </div>

            <button class="btn-save" onclick="saveData()"><i class="fas fa-database"></i> حفظ في Neon DB</button>
            <div id="msg" class="message"></div>
        </div>
    </div>
</div>

<script>
    function checkAuth() {
        if(document.getElementById('admin-password').value === 'zazo010988') {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
        }
    }

    async function generateAI() {
        const prompt = document.getElementById('ai-prompt').value;
        const res = await fetch('/api/raqqa-ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        document.getElementById('main-content').value = data.reply;
    }

    async function saveData() {
        const msg = document.getElementById('msg');
        const fileInput = document.getElementById('file-upload');
        let mediaUrl = document.getElementById('media-url').value;

        // إذا كان هناك ملف مرفوع، نحوله لـ Base64 (أو يمكنك رفعه لـ Vercel Blob)
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            mediaUrl = await toBase64(file);
        }

        const payload = {
            content: document.getElementById('main-content').value,
            media_url: mediaUrl, // هذا هو التعديل الجوهري لربط الفيديوهات
            section: document.getElementById('section-select').value,
            type: document.getElementById('type-select').value
        };

        try {
            const res = await fetch('/api/save-post', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                msg.textContent = "✅ تم النشر بنجاح!";
                msg.className = "message success";
                msg.style.display = "block";
            }
        } catch (e) {
            msg.textContent = "❌ خطأ في الحفظ";
            msg.className = "message error";
            msg.style.display = "block";
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>
</body>
</html>
